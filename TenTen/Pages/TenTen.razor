@page "/tenten"
@using System.Linq
@using Microsoft.AspNetCore.WebUtilities
@inject ITenTenService TenTenService
@inject ITopicService TopicService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<PageTitle>10&10 - TenTen</PageTitle>

<div class="tenten-container">
    <div class="navigation-breadcrumb">
        <a href="/" class="breadcrumb-link">
            <span class="bi bi-house"></span> í™ˆ
        </a>
        <span class="breadcrumb-separator">></span>
        <a href="/topics" class="breadcrumb-link">10&10 ê´€ë¦¬</a>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current">10&10 ì‘ì„±</span>
    </div>
    
    <div class="tenten-header">
        <h1>ğŸ’• 10&10</h1>
        <p>10ë¶„ê°„ ë§ˆìŒì„ ì ê³  10ë¶„ê°„ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì„¸ìš”</p>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (tenTens.Any())
    {
        <div class="tenten-list">
            @foreach (var tenTen in tenTens.OrderByDescending(t => t.CreatedAt))
            {
                <div class="tenten-card @(tenTen.IsReadByPartner ? "read" : "unread")">
                    <div class="tenten-header">
                        <div class="tenten-meta">
                            <span class="topic-badge">@tenTen.TopicSubject</span>
                            <span class="date-info">ì‘ì„±ì¼: @tenTen.CreatedAt.ToString("yyyy-MM-dd HH:mm")</span>
                        </div>
                        <div class="tenten-actions">
                            @if (tenTen.UserId == 1) // Dummy user ID for current user
                            {
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditTenTen(tenTen)" title="ìˆ˜ì •">
                                    <span class="bi bi-pencil"></span>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteTenTen(tenTen.Id)" title="ì‚­ì œ">
                                    <span class="bi bi-trash"></span>
                                </button>
                            }
                            else
                            {
                                @if (!tenTen.IsReadByPartner)
                                {
                                    <button class="btn btn-sm btn-success" @onclick="() => MarkAsRead(tenTen.Id)" title="ì½ìŒìœ¼ë¡œ í‘œì‹œ">
                                        <span class="bi bi-check-circle"></span> ì½ìŒ
                                    </button>
                                }
                            }
                        </div>
                    </div>
                    <div class="tenten-content">
                        <p>@tenTen.Content</p>
                    </div>
                    <div class="tenten-footer">
                        <div class="read-status">
                            @if (tenTen.IsReadByPartner)
                            {
                                <span class="badge bg-success">ì½ìŒ</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">ğŸ’–</div>
            <h3>ì•„ì§ ì‘ì„±ëœ 10&10ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì´ ì£¼ì œì— ëŒ€í•œ 10&10ì´ ì•„ì§ ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-primary" @onclick="ShowCreateModal">
                <span class="bi bi-pencil-square"></span> 10&10 ì‘ì„±í•˜ê¸°
            </button>
        </div>
    }
</div>

<!-- Create/Edit Full Screen -->
@if (showModal)
{
    <div class="fullscreen-editor">
        <div class="editor-container">
            <div class="editor-header">
                <h2>@(isEditing ? "10&10 ìˆ˜ì •" : "ìƒˆ 10&10 ì‘ì„±")</h2>
                <button type="button" class="btn btn-outline-secondary" @onclick="CloseModal">
                    <span class="bi bi-x-lg"></span> ë‹«ê¸°
                </button>
            </div>
            <div class="editor-content">
                <EditForm Model="currentTenTen" OnValidSubmit="SaveTenTen">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label>ì£¼ì œ</label>
                        <div class="selected-topic-display">
                            @if (selectedTopicId > 0)
                            {
                                var selectedTopic = topics.FirstOrDefault(t => t.Id == selectedTopicId);
                                if (selectedTopic != null)
                                {
                                    <div class="topic-info">
                                        <span class="topic-subject">@selectedTopic.Subject</span>
                                        <span class="topic-date">(@selectedTopic.TopicDate.ToString("yyyy-MM-dd"))</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">ì£¼ì œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="content">10&10 ë‚´ìš© *</label>
                        <InputTextArea id="content" @bind-Value="currentTenTen.Content" 
                                     class="form-control content-textarea" rows="20" 
                                     placeholder="10ë¶„ê°„ ë§ˆìŒì„ ì ì–´ë³´ì„¸ìš”..." />
                        <ValidationMessage For="@(() => currentTenTen.Content)" class="text-danger" />
                        <small class="form-text text-muted">ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    <div class="editor-actions">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            @(isEditing ? "ìˆ˜ì •" : "ì‘ì„±")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<TenTenEntry> tenTens = new();
    private List<Topic> topics = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private CreateTenTenRequest currentTenTen = new();
    private int? editingTenTenId = null;
    private int selectedTopicId = 0; // 0 for all topics

    protected override async Task OnInitializedAsync()
    {
        await LoadTopics();
        
        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ topicId í™•ì¸
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("topicId", out var topicIdValues))
        {
            if (int.TryParse(topicIdValues.FirstOrDefault(), out var topicId))
            {
                selectedTopicId = topicId;
            }
        }
        
        await LoadTenTens();
    }

    private async Task LoadTopics()
    {
        try
        {
            topics = await TopicService.GetTopicsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"ì£¼ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
    }

    private async Task LoadTenTens()
    {
        isLoading = true;
        try
        {
            if (selectedTopicId == 0)
            {
                tenTens = await TenTenService.GetTenTensAsync();
            }
            else
            {
                tenTens = await TenTenService.GetTenTensByTopicAsync(selectedTopicId);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"10&10ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTenTensForTopic()
    {
        await LoadTenTens();
    }

    private void ShowCreateModal()
    {
        isEditing = false;
        editingTenTenId = null;
        currentTenTen = new CreateTenTenRequest
        {
            TopicId = selectedTopicId
        };
        errorMessage = string.Empty;
        showModal = true;
    }

    private void EditTenTen(TenTenEntry tenTen)
    {
        isEditing = true;
        editingTenTenId = tenTen.Id;
        currentTenTen = new CreateTenTenRequest
        {
            Content = tenTen.Content,
            TopicId = tenTen.TopicId
        };
        errorMessage = string.Empty;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        isEditing = false;
        editingTenTenId = null;
        currentTenTen = new CreateTenTenRequest();
        errorMessage = string.Empty;
    }

    private async Task SaveTenTen()
    {
        isSaving = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            if (isEditing && editingTenTenId.HasValue)
            {
                var updateRequest = new UpdateTenTenRequest
                {
                    Content = currentTenTen.Content
                };
                await TenTenService.UpdateTenTenAsync(editingTenTenId.Value, updateRequest);
            }
            else
            {
                await TenTenService.CreateTenTenAsync(currentTenTen);
            }

            await LoadTenTens();
            CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"10&10 ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteTenTen(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "ì •ë§ë¡œ ì´ 10&10ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))
        {
            try
            {
                var success = await TenTenService.DeleteTenTenAsync(id);
                if (success)
                {
                    await LoadTenTens();
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"10&10 ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
            }
        }
    }

    private async Task MarkAsRead(int id)
    {
        try
        {
            var success = await TenTenService.MarkAsReadAsync(id);
            if (success)
            {
                await LoadTenTens();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"10&10 ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
    }
}
